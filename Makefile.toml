[config]
default_to_workspace = false

[tasks.add-stub-dependency-core-driver]
args = ["stubgen", "add-stub-dependency", "--stub-wit-root", "core-stub/wit", "--dest-wit-root", "driver/wit", "--overwrite", "--update-cargo-toml"]
command = "golem-cli"
cwd = "."
dependencies = ["generate-core-stub"]

[tasks.add-stub-dependency-event-processor-core]
args = ["stubgen", "add-stub-dependency", "--stub-wit-root", "event-processor-stub/wit", "--dest-wit-root", "core/wit", "--overwrite", "--update-cargo-toml"]
command = "golem-cli"
cwd = "."
dependencies = ["generate-event-processor-stub"]

[tasks.add-stub-dependency-timeline-processor-core]
args = ["stubgen", "add-stub-dependency", "--stub-wit-root", "timeline-processor-stub/wit", "--dest-wit-root", "core/wit", "--overwrite", "--update-cargo-toml"]
command = "golem-cli"
cwd = "."

[tasks.add-stub-dependency-event-processor-timline-processor]
args = ["stubgen", "add-stub-dependency", "--stub-wit-root", "event-processor-stub/wit", "--dest-wit-root", "timeline-processor/wit", "--overwrite", "--update-cargo-toml"]
command = "golem-cli"
cwd = "."
dependencies = ["generate-event-processor-stub"]

# Not to be called untl wasm-rpc is fixed
[tasks.add-stub-dependency-timeline-processor-timeline-processor]
args = ["stubgen", "add-stub-dependency", "--stub-wit-root", "timeline-processor-stub/wit", "--dest-wit-root", "timeline-processor/wit", "--overwrite", "--update-cargo-toml"]
command = "golem-cli"
cwd = "."

[tasks.build]
args = ["build"]
command = "cargo-component"
dependencies = ["clean", "regenerate-stubs"]

[tasks.build-flow]
dependencies = ["build", "post-build"]

[tasks.build-release]
args = ["build", "--release"]
command = "cargo-component"
dependencies = ["clean", "regenerate-stubs"]

[tasks.clean]
args = ["clean"]
command = "cargo-component"

[tasks.compose-driver]
args = ["stubgen", "compose", "--source-wasm", "target/wasm32-wasi/debug/driver.wasm", "--stub-wasm", "target/wasm32-wasi/debug/core_stub.wasm", "--dest-wasm", "target/wasm32-wasi/debug/driver_with_core.wasm"]
command = "golem-cli"
cwd = "."

[tasks.compose-release-driver]
args = ["stubgen", "compose", "--source-wasm", "target/wasm32-wasi/release/driver.wasm", "--stub-wasm", "target/wasm32-wasi/release/core_stub.wasm", "--dest-wasm", "target/wasm32-wasi/release/driver_with_core.wasm"]
command = "golem-cli"
cwd = "."

[tasks.compose-core-with-event-processor]
args = ["stubgen", "compose", "--source-wasm", "target/wasm32-wasi/debug/core.wasm", "--stub-wasm", "target/wasm32-wasi/debug/event_processor_stub.wasm", "--dest-wasm", "target/wasm32-wasi/debug/core_with_event.wasm"]
command = "golem-cli"
cwd = "."

[tasks.compose-core-with-event-processor-with-timeline-processor]
args = ["stubgen", "compose", "--source-wasm", "target/wasm32-wasi/debug/core_with_event.wasm", "--stub-wasm", "target/wasm32-wasi/debug/timeline_processor_stub.wasm", "--dest-wasm", "target/wasm32-wasi/debug/core_with_event_with_timeline.wasm"]
command = "golem-cli"
cwd = "."


[tasks.compose-release-core-with-event-processor]
args = ["stubgen", "compose", "--source-wasm", "target/wasm32-wasi/release/core.wasm", "--stub-wasm", "target/wasm32-wasi/release/event_processor_stub.wasm", "--dest-wasm", "target/wasm32-wasi/release/core_with_event.wasm"]
command = "golem-cli"
cwd = "."

[tasks.compose-release-core-with-event-processor-with-timeline-processor]
args = ["stubgen", "compose", "--source-wasm", "target/wasm32-wasi/release/core_with_event.wasm", "--stub-wasm", "target/wasm32-wasi/release/timeline_processor_stub.wasm", "--dest-wasm", "target/wasm32-wasi/release/core_with_event_with_timeline.wasm"]
command = "golem-cli"
cwd = "."


[tasks.compose-timeline-processor-with-event-processor]
args = ["stubgen", "compose", "--source-wasm", "target/wasm32-wasi/debug/timeline_processor.wasm", "--stub-wasm", "target/wasm32-wasi/debug/event_processor_stub.wasm", "--dest-wasm", "target/wasm32-wasi/debug/timeline_with_event.wasm"]
command = "golem-cli"
cwd = "."

[tasks.compose-release-timeline-processor-with-event-processor]
args = ["stubgen", "compose", "--source-wasm", "target/wasm32-wasi/release/timeline_processor.wasm", "--stub-wasm", "target/wasm32-wasi/release/event_processor_stub.wasm", "--dest-wasm", "target/wasm32-wasi/release/timeline_with_event.wasm"]
command = "golem-cli"
cwd = "."

[tasks.compose-timeline-and-event-with-timeline-processor]
args = ["stubgen", "compose", "--source-wasm", "target/wasm32-wasi/debug/timeline_with_event.wasm", "--stub-wasm", "target/wasm32-wasi/debug/timeline_processor_stub.wasm", "--dest-wasm", "target/wasm32-wasi/debug/timeline_with_event_with_timeline.wasm"]
command = "golem-cli"
cwd = "."

[tasks.compose-release-timeline-and-event-with-timeline-processor]
args = ["stubgen", "compose", "--source-wasm", "target/wasm32-wasi/release/timeline_with_event.wasm", "--stub-wasm", "target/wasm32-wasi/release/timeline_processor_stub.wasm", "--dest-wasm", "target/wasm32-wasi/release/timeline_with_event_with_timeline.wasm"]
command = "golem-cli"
cwd = "."


[tasks.default]
alias = "build"

[tasks.generate-core-stub]
args = ["stubgen", "generate", "-s", "core/wit", "-d", "core-stub"]
command = "golem-cli"
cwd = "."


[tasks.generate-event-processor-stub]
args = ["stubgen", "generate", "-s", "event-processor/wit", "-d", "event-processor-stub"]
command = "golem-cli"
cwd = "."


[tasks.post-build]
dependencies = ["compose-driver", "compose-core-with-event-processor", "compose-timeline-processor-with-event-processor", "compose-core-with-event-processor-with-timeline-processor"]

[tasks.post-build-release]
dependencies = ["compose-release-driver", "compose-release-core-with-event-processor", "compose-release-timeline-processor-with-event-processor", "compose-release-core-with-event-processor-with-timeline-processor"]

[tasks.regenerate-stubs]
dependencies = ["add-stub-dependency-core-driver", "add-stub-dependency-event-processor-core", "add-stub-dependency-timeline-processor-core", "add-stub-dependency-event-processor-timline-processor"]

[tasks.release-build-flow]
dependencies = ["build-release", "post-build-release"]

[tasks.test]
args = ["test"]
command = "cargo-component"
dependencies = ["clean"]
